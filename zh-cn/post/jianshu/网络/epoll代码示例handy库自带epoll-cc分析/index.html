<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="å‰è¨€ C++ç½‘ç»œåº“æœ‰å¾ˆå¤šã€‚handyæ˜¯ä¸€ä¸ªC++11é£æ ¼çš„ç½‘ç»œåº“ï¼Œå¯¹æ·±å…¥å­¦ä¹ C++æœ‰å¾ˆå¤§å¸®åŠ©ã€‚ ä»£ç åˆ†æ ä¸‹é¢æ˜¯æ¥è‡ªhandy/raw_examplesä¸‹çš„epoll.ccæ–‡ä»¶ã€‚æ˜¯æ°´å¹³è§¦å‘çš„ä¸€ä¸ªç¤ºä¾‹ã€‚è¯¥httpæœåŠ¡å™¨æ— è®ºæ¥æ”¶åˆ°ä»€ä¹ˆæ ·çš„è¯·æ±‚ï¼Œéƒ½è¿”å›ä¸€ä¸ªé™æ€èµ„æº123456ã€‚ç¼–è¯‘ï¼šc++ -o epoll epoll.ccï¼Œè¿è¡Œï¼š sudo ./epollã€‚æºä»£ç ä¸­sendResçš„if (con.writeEnabled)è¿™å¥ä¼¼ä¹æœ‰äº›é—®é¢˜ï¼Œå¯¼è‡´å‘é€è¶…å¤§èµ„æºæ—¶å‡ºç°é—®é¢˜ã€‚æˆ‘å·²ç»åšäº†ä¿®æ”¹ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ­£ç¡®å‘é€è¶…å¤§æ–‡ä»¶ã€‚ /* * ç¼–è¯‘ï¼šc++ -o epoll epoll.cc * è¿è¡Œï¼š ./epoll * æµ‹è¯•ï¼šcurl -v localhost */ /* è¿è¡Œæ•ˆæœ ä½¿ç”¨sudo è¿è¡Œepollç¨‹åºã€‚è¯¥ç¨‹åºåœ¨æœ¬æœº0.0.0.0çš„80ç«¯å£ç›‘å¬ï¼Œä½œä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨è¿è¡Œ æ¯å½“æœ‰è¿æ¥è®¿é—®æ—¶ï¼Œè¿”å›é™æ€èµ„æºhttpRes LTæ˜¯é»˜è®¤æ¨¡å¼ */ #include &lt;sys/socket.h&gt; #include &lt;sys/epoll.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;map&gt; #include &lt;string&gt; #include &lt;signal.h&gt; #include &lt;iostream&gt; using namespace std; bool output_log = true; // ä¸€ä¸ªå®ï¼Œç”¨æ¥æ‰“å°é”™è¯¯å¹¶é€€å‡º #define exit_if(r, .">
<title>epollä»£ç ç¤ºä¾‹â€”â€”handyåº“è‡ªå¸¦epoll.ccåˆ†æ</title>

<link rel='canonical' href='https://nansenli.com/zh-cn/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.b9b97e7c3f7f078f7ec4f60195f6139d30ad5972cc05950321ee04a9e98c542f.css"><meta property='og:title' content="epollä»£ç ç¤ºä¾‹â€”â€”handyåº“è‡ªå¸¦epoll.ccåˆ†æ">
<meta property='og:description' content="å‰è¨€ C++ç½‘ç»œåº“æœ‰å¾ˆå¤šã€‚handyæ˜¯ä¸€ä¸ªC++11é£æ ¼çš„ç½‘ç»œåº“ï¼Œå¯¹æ·±å…¥å­¦ä¹ C++æœ‰å¾ˆå¤§å¸®åŠ©ã€‚ ä»£ç åˆ†æ ä¸‹é¢æ˜¯æ¥è‡ªhandy/raw_examplesä¸‹çš„epoll.ccæ–‡ä»¶ã€‚æ˜¯æ°´å¹³è§¦å‘çš„ä¸€ä¸ªç¤ºä¾‹ã€‚è¯¥httpæœåŠ¡å™¨æ— è®ºæ¥æ”¶åˆ°ä»€ä¹ˆæ ·çš„è¯·æ±‚ï¼Œéƒ½è¿”å›ä¸€ä¸ªé™æ€èµ„æº123456ã€‚ç¼–è¯‘ï¼šc++ -o epoll epoll.ccï¼Œè¿è¡Œï¼š sudo ./epollã€‚æºä»£ç ä¸­sendResçš„if (con.writeEnabled)è¿™å¥ä¼¼ä¹æœ‰äº›é—®é¢˜ï¼Œå¯¼è‡´å‘é€è¶…å¤§èµ„æºæ—¶å‡ºç°é—®é¢˜ã€‚æˆ‘å·²ç»åšäº†ä¿®æ”¹ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ­£ç¡®å‘é€è¶…å¤§æ–‡ä»¶ã€‚ /* * ç¼–è¯‘ï¼šc++ -o epoll epoll.cc * è¿è¡Œï¼š ./epoll * æµ‹è¯•ï¼šcurl -v localhost */ /* è¿è¡Œæ•ˆæœ ä½¿ç”¨sudo è¿è¡Œepollç¨‹åºã€‚è¯¥ç¨‹åºåœ¨æœ¬æœº0.0.0.0çš„80ç«¯å£ç›‘å¬ï¼Œä½œä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨è¿è¡Œ æ¯å½“æœ‰è¿æ¥è®¿é—®æ—¶ï¼Œè¿”å›é™æ€èµ„æºhttpRes LTæ˜¯é»˜è®¤æ¨¡å¼ */ #include &lt;sys/socket.h&gt; #include &lt;sys/epoll.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;map&gt; #include &lt;string&gt; #include &lt;signal.h&gt; #include &lt;iostream&gt; using namespace std; bool output_log = true; // ä¸€ä¸ªå®ï¼Œç”¨æ¥æ‰“å°é”™è¯¯å¹¶é€€å‡º #define exit_if(r, .">
<meta property='og:url' content='https://nansenli.com/zh-cn/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/'>
<meta property='og:site_name' content='Nansen Li&#39;s Blog
ææ¥ æ£®çš„åšå®¢
'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2018-05-16T07:43:00&#43;00:00'/><meta property='article:modified_time' content='2018-05-16T07:43:00&#43;00:00'/>
<meta name="twitter:title" content="epollä»£ç ç¤ºä¾‹â€”â€”handyåº“è‡ªå¸¦epoll.ccåˆ†æ">
<meta name="twitter:description" content="å‰è¨€ C++ç½‘ç»œåº“æœ‰å¾ˆå¤šã€‚handyæ˜¯ä¸€ä¸ªC++11é£æ ¼çš„ç½‘ç»œåº“ï¼Œå¯¹æ·±å…¥å­¦ä¹ C++æœ‰å¾ˆå¤§å¸®åŠ©ã€‚ ä»£ç åˆ†æ ä¸‹é¢æ˜¯æ¥è‡ªhandy/raw_examplesä¸‹çš„epoll.ccæ–‡ä»¶ã€‚æ˜¯æ°´å¹³è§¦å‘çš„ä¸€ä¸ªç¤ºä¾‹ã€‚è¯¥httpæœåŠ¡å™¨æ— è®ºæ¥æ”¶åˆ°ä»€ä¹ˆæ ·çš„è¯·æ±‚ï¼Œéƒ½è¿”å›ä¸€ä¸ªé™æ€èµ„æº123456ã€‚ç¼–è¯‘ï¼šc++ -o epoll epoll.ccï¼Œè¿è¡Œï¼š sudo ./epollã€‚æºä»£ç ä¸­sendResçš„if (con.writeEnabled)è¿™å¥ä¼¼ä¹æœ‰äº›é—®é¢˜ï¼Œå¯¼è‡´å‘é€è¶…å¤§èµ„æºæ—¶å‡ºç°é—®é¢˜ã€‚æˆ‘å·²ç»åšäº†ä¿®æ”¹ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ­£ç¡®å‘é€è¶…å¤§æ–‡ä»¶ã€‚ /* * ç¼–è¯‘ï¼šc++ -o epoll epoll.cc * è¿è¡Œï¼š ./epoll * æµ‹è¯•ï¼šcurl -v localhost */ /* è¿è¡Œæ•ˆæœ ä½¿ç”¨sudo è¿è¡Œepollç¨‹åºã€‚è¯¥ç¨‹åºåœ¨æœ¬æœº0.0.0.0çš„80ç«¯å£ç›‘å¬ï¼Œä½œä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨è¿è¡Œ æ¯å½“æœ‰è¿æ¥è®¿é—®æ—¶ï¼Œè¿”å›é™æ€èµ„æºhttpRes LTæ˜¯é»˜è®¤æ¨¡å¼ */ #include &lt;sys/socket.h&gt; #include &lt;sys/epoll.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;map&gt; #include &lt;string&gt; #include &lt;signal.h&gt; #include &lt;iostream&gt; using namespace std; bool output_log = true; // ä¸€ä¸ªå®ï¼Œç”¨æ¥æ‰“å°é”™è¯¯å¹¶é€€å‡º #define exit_if(r, .">
    <link rel="shortcut icon" href="/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-WC38C3XE3J"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-WC38C3XE3J');
        }
      </script>
    
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/zh-cn/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu96777ff80939aaa7d938dddcc232fcc6_1414962_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸŒˆ</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/zh-cn">Nansen Li&#39;s Blog
ææ¥ æ£®çš„åšå®¢
</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/linanwx'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/nansen-li-3bb0a3146/'
                        target="_blank"
                        title="LinkedIn"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 11v5" /><path d="M8 8v.01" /><path d="M12 16v-5" /><path d="M16 16v-3a2 2 0 1 0 -4 0" /><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/zh-cn/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://nansenli.com/" >English</option>
                                
                                    <option value="https://nansenli.com/zh-cn/" selected>ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/zh-cn/categories/%E7%BD%91%E7%BB%9C/" >
                ç½‘ç»œ
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/zh-cn/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/">epollä»£ç ç¤ºä¾‹â€”â€”handyåº“è‡ªå¸¦epoll.ccåˆ†æ</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 16, 2018</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 6 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
        <footer class="article-translations">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



            <div>
                
                    <a href="https://nansenli.com/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/" class="link">English</a>
                
            </div>
        </footer>
    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="å‰è¨€">å‰è¨€
</h2><p>C++ç½‘ç»œåº“æœ‰å¾ˆå¤šã€‚handyæ˜¯ä¸€ä¸ªC++11é£æ ¼çš„ç½‘ç»œåº“ï¼Œå¯¹æ·±å…¥å­¦ä¹ C++æœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p>
<h2 id="ä»£ç åˆ†æ">ä»£ç åˆ†æ
</h2><p>ä¸‹é¢æ˜¯æ¥è‡ªhandy/raw_examplesä¸‹çš„epoll.ccæ–‡ä»¶ã€‚æ˜¯æ°´å¹³è§¦å‘çš„ä¸€ä¸ªç¤ºä¾‹ã€‚è¯¥httpæœåŠ¡å™¨æ— è®ºæ¥æ”¶åˆ°ä»€ä¹ˆæ ·çš„è¯·æ±‚ï¼Œéƒ½è¿”å›ä¸€ä¸ªé™æ€èµ„æº123456ã€‚ç¼–è¯‘ï¼šc++ -o epoll epoll.ccï¼Œè¿è¡Œï¼š sudo ./epollã€‚æºä»£ç ä¸­sendResçš„if (con.writeEnabled)è¿™å¥ä¼¼ä¹æœ‰äº›é—®é¢˜ï¼Œå¯¼è‡´å‘é€è¶…å¤§èµ„æºæ—¶å‡ºç°é—®é¢˜ã€‚æˆ‘å·²ç»åšäº†ä¿®æ”¹ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ­£ç¡®å‘é€è¶…å¤§æ–‡ä»¶ã€‚</p>
<pre tabindex="0"><code>/*
 * ç¼–è¯‘ï¼šc++ -o epoll epoll.cc
 * è¿è¡Œï¼š ./epoll
 * æµ‹è¯•ï¼šcurl -v localhost
 */


/* 
    è¿è¡Œæ•ˆæœ
    ä½¿ç”¨sudo è¿è¡Œepollç¨‹åºã€‚è¯¥ç¨‹åºåœ¨æœ¬æœº0.0.0.0çš„80ç«¯å£ç›‘å¬ï¼Œä½œä¸ºä¸€ä¸ªhttpæœåŠ¡å™¨è¿è¡Œ
    æ¯å½“æœ‰è¿æ¥è®¿é—®æ—¶ï¼Œè¿”å›é™æ€èµ„æºhttpRes
    LTæ˜¯é»˜è®¤æ¨¡å¼

 */

#include &lt;sys/socket.h&gt;
#include &lt;sys/epoll.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;map&gt;
#include &lt;string&gt;
#include &lt;signal.h&gt;
#include &lt;iostream&gt;
using namespace std;


bool output_log = true;
// ä¸€ä¸ªå®ï¼Œç”¨æ¥æ‰“å°é”™è¯¯å¹¶é€€å‡º
#define exit_if(r, ...) if(r) {printf(__VA_ARGS__); printf(&#34;%s:%d error no: %d error msg %s\n&#34;, __FILE__, __LINE__, errno, strerror(errno)); exit(1);}
// è¿™ä¸ªå‡½æ•°ç”¨äºå°†æŒ‡å®šçš„fdè®¾ç½®ä¸ºéé˜»å¡çŠ¶æ€
void setNonBlock(int fd) {
    // é¦–å…ˆæˆ‘ä»¬å–å‡ºåŸæ¥æ–‡ä»¶æè¿°ç¬¦çš„flags
    int flags = fcntl(fd, F_GETFL, 0);
    exit_if(flags&lt;0, &#34;fcntl failed&#34;);
    // ç„¶ååŠ ä¸ŠO_NONBLOCKï¼Œå†è®¾ç½®å›å»
    int r = fcntl(fd, F_SETFL, flags | O_NONBLOCK);
    exit_if(r&lt;0, &#34;fcntl failed&#34;);
}
// å¯¹epoll_ctläºŒæ¬¡åŒ…è£…ï¼Œå°†events å’Œ fdæ”¾å…¥evä¸­ã€‚
// å¹¶ä¸”è®¾ç½®events è®¾ç½®ä¸ºå¯è¯»å¯å†™æ—¶è§¦å‘
void updateEvents(int efd, int fd, int events, int op) {
    struct epoll_event ev = {0};
    ev.events = events;
    ev.data.fd = fd;
    printf(&#34;%s fd %d events read %d write %d\n&#34;,
           op==EPOLL_CTL_MOD?&#34;mod&#34;:&#34;add&#34;, fd, ev.events &amp; EPOLLIN, ev.events &amp; EPOLLOUT);
    int r = epoll_ctl(efd, op, fd, &amp;ev);
    exit_if(r, &#34;epoll_ctl failed&#34;);
}
// å°è¯•åœ¨fdä¸Šåšacceptæ“ä½œã€‚å¦‚æœæˆåŠŸï¼Œå°†å…¶åŠ å…¥åˆ°epoll fdçš„ç›‘å¬åˆ—è¡¨ä¸­ã€‚epollçš„eventsè®¾ç½®ä¸ºå½“æ•°æ®æœ‰å†™å…¥çš„æ—¶å€™è§¦å‘ã€‚
void handleAccept(int efd, int fd) {
    struct sockaddr_in raddr;
    socklen_t rsz = sizeof(raddr);
    int cfd = accept(fd,(struct sockaddr *)&amp;raddr,&amp;rsz);
    exit_if(cfd&lt;0, &#34;accept failed&#34;);
    sockaddr_in peer, local;
    socklen_t alen = sizeof(peer);
    int r = getpeername(cfd, (sockaddr*)&amp;peer, &amp;alen);
    exit_if(r&lt;0, &#34;getpeername failed&#34;);
    printf(&#34;accept a connection from %s\n&#34;, inet_ntoa(raddr.sin_addr));
    setNonBlock(cfd);
    updateEvents(efd, cfd, EPOLLIN, EPOLL_CTL_ADD);
}
// è¡¨ç¤ºä¸€ä¸ªè¿æ¥ã€‚æˆå‘˜æœ‰è¿æ¥å·²è¯»å–çš„æ•°æ®ã€å·²å†™å…¥çš„æ•°æ®
// stringç”¨æ¥ä¿å­˜äºŒè¿›åˆ¶å†…å®¹æ²¡æœ‰é—®é¢˜å—ï¼Œå¦‚æœé‡åˆ°\0ä¼šå¦‚ä½•ï¼Ÿ
// æ²¡æœ‰é—®é¢˜https://www.zhihu.com/question/33104941
struct Con {
    string readed;
    size_t written;
    bool writeEnabled;
    Con(): written(0), writeEnabled(false) {}
};
// ç”¨æ¥æ˜ å°„fdä¸conçš„æ•°æ®ç»“æ„
map&lt;int, Con&gt; cons;

string httpRes;
// å‘é€èµ„æº
void sendRes(int efd, int fd) {
    // é¦–å…ˆå–å¾—è¿æ¥ä¿¡æ¯
    Con&amp; con = cons[fd];
    // æ²¡æœ‰æ¥å—åˆ°æ•°æ®å°±è¦æ±‚å†™å…¥
    // è¯´æ˜å…¶å¯èƒ½ä¸Šä¸€æ¬¡ç»§ç»­å‘é€çš„æ•°æ®å‘é€å®Œäº†
    // å…¶å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦åœ¨consä¸­å·²ç»åˆ é™¤
    // ç„¶åè§¦å‘äº†epollä¿¡å·
    // æ­¤æ—¶å…³é—­å…¶ä¸Šä¸€æ¬¡å‘é€çš„æ ‡å¿—
    // ç„¶åå…³é—­å…¶ç¼“å†²åŒºå‘é€è§¦å‘epollçš„æ ‡å¿—
    // åªä¿ç•™å…¶æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘
    // ä¸ºä»€ä¹ˆä¸åœ¨å†™å…¥å®Œæ•°æ®æ—¶å°±å°†è¿™æ­¥åšäº†å‘¢ï¼Ÿ
    // if (!con.readed.length()) {
    //     if (con.writeEnabled) {
    //         updateEvents(efd, fd, EPOLLIN, EPOLL_CTL_MOD);
    //         con.writeEnabled = false;
    //     }
    //     return;
    // }
    // è®¡ç®—è¿˜éœ€è¦å†™å…¥çš„æ•°æ®é•¿åº¦
    size_t left = httpRes.length() - con.written;
    int wd = 0;
    // è¿ç»­å†™å…¥æ•°æ®ï¼Œç›´åˆ°å†…æ ¸ç¼“å†²åŒºæ— æ³•å†™å…¥æ•°æ®ä¸ºæ­¢
    while((wd=::write(fd, httpRes.data()+con.written, left))&gt;0) {
        con.written += wd;
        left -= wd;
        if(output_log) printf(&#34;write %d bytes left: %lu\n&#34;, wd, left);
    };
    // å¦‚æœæ²¡æœ‰æ•°æ®å¯ä»¥å†™å…¥ï¼Œåˆ™åˆ é™¤è¿™ä¸ªè¿æ¥ã€‚ä½†æ˜¯ä¸æ–­å¼€è¿æ¥ï¼Œå³å°†è¿æ¥ä¿¡æ¯ç½®ç©º
    if (left == 0) {
//        close(fd); // æµ‹è¯•ä¸­ä½¿ç”¨äº†keepaliveï¼Œå› æ­¤ä¸å…³é—­è¿æ¥ã€‚è¿æ¥ä¼šåœ¨readäº‹ä»¶ä¸­å…³é—­
        if (con.writeEnabled) {
            updateEvents(efd, fd, EPOLLIN, EPOLL_CTL_MOD);
            con.writeEnabled = false;
        }
        cons.erase(fd);
        return;
    }
    // å¦‚æœå†…æ ¸ç¼“å†²åŒºæ»¡äº†ï¼Œæ²¡åŠæ³•å†™å…¥äº†
    if (wd &lt; 0 &amp;&amp;  (errno == EAGAIN || errno == EWOULDBLOCK)) {
        // å°†å…¶æ ‡è®°ä¸Šå¯ç»§ç»­å†™
        if (!con.writeEnabled) {
            // ç­‰å¾…å…¶å¯ç»§ç»­å†™ï¼Œæˆ–å¯è¯»
            // é¿å…é‡å¤è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨con.writeEnabledæ ‡è®°ä½
            printf(&#34;update it to EPOLLIN|EPOLLOUT\n&#34;);
            updateEvents(efd, fd, EPOLLIN|EPOLLOUT, EPOLL_CTL_MOD);
            con.writeEnabled = true;
        }
        return;
    }
    // å¦‚æœæ˜¯å…¶ä»–æƒ…å†µï¼Œæ¯”å¦‚åœ¨æ²¡æœ‰å†™å®Œæ•°æ®æ—¶ç›´æ¥è¿”å›0ï¼Œæˆ–è€…æ˜¯è¿”å›äº†å…¶ä»–é”™è¯¯
    // åˆ™è¯´æ˜å‡ºé”™äº†
    if (wd&lt;=0) {
        printf(&#34;write error for %d: %d %s\n&#34;, fd, errno, strerror(errno));
        close(fd);
        cons.erase(fd);
    }
}
// å½“loop onceå¤„ç†è¯»å–æ•°æ®æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°
void handleRead(int efd, int fd) {
    char buf[4096];
    int n = 0;
    // æ¯æ¬¡è¯»å–4kå­—èŠ‚ï¼Œå¾ªç¯è¯»å‡ºå½“å‰å†…æ ¸ä¸­å·²å­˜åœ¨çš„æ•°æ®ï¼ˆæœ‰å¯èƒ½åˆ†åŒ…å¯¼è‡´ä¿¡æ¯ä¸å®Œæ•´ï¼‰
    while ((n=::read(fd, buf, sizeof buf)) &gt; 0) {
        if(output_log) printf(&#34;read %d bytes\n&#34;, n);
        // è¿™é‡Œé€šè¿‡ä¸€ä¸ªmapæ¥è·å–ä¹‹å‰fdå¯¹åº”çš„è¿æ¥ä¿¡æ¯ã€‚
        // å½“fdå¯¹åº”çš„ä¸‹æ ‡ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œåˆ™ä¼šè°ƒç”¨conçš„é»˜è®¤æ„é€ å‡½æ•°Con(): written(0), writeEnabled(false) {}
        string&amp; readed = cons[fd].readed;
        // è°ƒç”¨stringç±»çš„appendæ–¹æ³•å°†æ•°æ®åŠ å…¥åˆ°è¿æ¥ä¿¡æ¯ä¸­
        // æ³¨æ„ä¸ºäº†ä¿è¯äºŒè¿›åˆ¶å®‰å…¨éœ€è¦ä¼ å…¥å‚æ•°n
        readed.append(buf, n);
        std::cout  &lt;&lt; &#34;now info is&#34; &lt;&lt; std::endl &lt;&lt; &#34;---&#34; &lt;&lt;  readed &lt;&lt; endl &lt;&lt; &#34;---&#34; &lt;&lt;  std::endl;
        // åˆ¤æ–­ä¸€ä¸ªhttpè¯·æ±‚å‘é€å®Œæ¯•ã€‚
        // ä¸åˆ¤æ–­httpè¯·æ±‚çš„å†…å®¹ï¼Œä¸€å¾‹å‘é€é™æ€èµ„æº
        if (readed.length()&gt;4) {
            if (readed.substr(readed.length()-2, 2) == &#34;\n\n&#34; || readed.substr(readed.length()-4, 4) == &#34;\r\n\r\n&#34;) {
                //å½“è¯»å–åˆ°ä¸€ä¸ªå®Œæ•´çš„httpè¯·æ±‚ï¼Œæµ‹è¯•å‘é€å“åº”
                // TCPè¿æ¥å»ºç«‹èµ·æ¥ä¹‹åï¼Œå®¢æˆ·ç«¯å°±å¼€å§‹ä¼ è¾“é¦–éƒ¨ï¼Œç„¶åä»¥\r\n\r\næ¥æ ‡å¿—é¦–éƒ¨çš„ç»“æŸå’Œå®ä½“çš„å¼€å§‹ï¼ˆå½“ç„¶æ˜¯è¯·æ±‚é‡ŒåŒ…å«å®ä½“æ‰ä¼šæœ‰å®ä½“çš„å¼€å§‹ï¼‰ï¼Œ
                // æ¥ä¸‹æ¥å°±æ˜¯å®ä½“çš„ä¼ è¾“ï¼Œå½“å®ä½“ä¼ è¾“å®Œä¹‹åï¼Œå®¢æˆ·ç«¯å°±å¼€å§‹æ¥æ”¶æ•°æ®ï¼ŒæœåŠ¡å™¨å°±çŸ¥é“ï¼Œè¿™æ¬¡è¯·æ±‚å°±å·²ç»ç»“æŸäº†ï¼Œ
                // é‚£ä¹ˆå®ä½“å°±æ˜¯\r\n\r\nåˆ°åœæ­¢æ¥æ”¶çš„é‚£ä¹ˆä¸€æ®µæ•°æ®ã€‚å¯¹åº”çš„ï¼Œå®¢æˆ·ç«¯æ¥æ”¶å“åº”çš„æ—¶å€™ä¹Ÿæ˜¯è¿™æ ·ã€‚
                // æ²¡æœ‰å®ä½“ï¼Œåˆ™\r\n\r\nå°±æ˜¯httpçš„ç»“æŸ
                // å¼€å§‹å†™å…¥æ•°æ®ã€‚æ³¨æ„æœ‰å¯èƒ½ä½¿ç¼“å†²åŒºå†™æ»¡ï¼Œè‹¥å†™æ»¡äº†åˆ™åœ¨ä¹‹åç»§ç»­å†™å…¥
                sendRes(efd, fd);
            }
        }
    }
    // readæ— æ³•è¯»å–çš„è¯ï¼Œå°±ä¼šè¿”å›-1ã€‚æ­¤æ—¶errnoï¼ˆerrnoæ˜¯å±äºçº¿ç¨‹çš„ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼‰æ˜¯EAGAINä»£è¡¨æ²¡è¯»å®Œã€‚EWOULDBLOCKå’ŒEAGAINæ˜¯ä¸€æ ·çš„ã€‚
    // é‚£å°±è¿”å›ï¼Œç„¶åç­‰å¾…ä¸‹æ¬¡å†è¯»å–
    if (n&lt;0 &amp;&amp; (errno == EAGAIN || errno == EWOULDBLOCK)){
        printf(&#34;nothing to read from %d, return. \n&#34;, fd);
        return;
    }
    //å®é™…åº”ç”¨ä¸­ï¼Œn&lt;0åº”å½“æ£€æŸ¥å„ç±»é”™è¯¯ï¼Œå¦‚EINTR
    if (n &lt; 0) {
        printf(&#34;read %d error: %d %s\n&#34;, fd, errno, strerror(errno));
    }
    // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œnæ˜¯0ï¼Œè¡¨ç¤ºå¯¹ç«¯å…³é—­è¿æ¥ã€‚è¿™æ—¶æˆ‘ä»¬ä¹Ÿå…³é—­è¿æ¥
    printf(&#34;%d close the connection\n&#34;, fd);
    close(fd);
    cons.erase(fd);
}
// å½“loop onceç¼“å†²åŒºå¯å†™çš„æ—¶å€™ï¼Œç®€å•çš„å†™å…¥æˆ‘ä»¬å‡†å¤‡å¥½çš„é™æ€èµ„æº
void handleWrite(int efd, int fd) {
    sendRes(efd, fd);
}
// å¯¹ä¸€ä¸ªepollå¥æŸ„è¿›è¡Œå¾ªç¯ä¸­çš„ä¸€æ¬¡æ“ä½œ
// å…¶ä¸­læ˜¯LISTENçš„fd
void loop_once(int efd, int lfd, int waitms) {
    // æœ€å¤šè®©å†…æ ¸æ‹·è´20ä¸ªäº‹ä»¶å‡ºæ¥
    const int kMaxEvents = 20;
    struct epoll_event activeEvs[100];
    int n = epoll_wait(efd, activeEvs, kMaxEvents, waitms);
    // næ˜¯è¿”å›äº†å¤šå°‘ä¸ªäº‹ä»¶
    if(output_log) printf(&#34;epoll_wait return %d\n&#34;, n);
    for (int i = 0; i &lt; n; i ++) {
        int fd = activeEvs[i].data.fd;
        int events = activeEvs[i].events;
        // EPOLLIN äº‹ä»¶æˆ–è€…æ˜¯ EPOLLERRäº‹ä»¶ã€‚EPOLLERRä¹Ÿä»£è¡¨ç®¡é“å†™å…¥ç»“æŸã€‚
        // å‚è§ï¼š http://man7.org/linux/man-pages/man2/epoll_ctl.2.html
        if (events &amp; (EPOLLIN | EPOLLERR)) {
            // EPOLLINäº‹ä»¶åˆ™åªæœ‰å½“å¯¹ç«¯æœ‰æ•°æ®å†™å…¥æ—¶æ‰ä¼šè§¦å‘ï¼Œæ‰€ä»¥è§¦å‘ä¸€æ¬¡åéœ€è¦ä¸æ–­è¯»å–æ‰€æœ‰æ•°æ®ç›´åˆ°è¯»å®ŒEAGAINä¸ºæ­¢ã€‚å¦åˆ™å‰©ä¸‹çš„æ•°æ®åªæœ‰åœ¨ä¸‹æ¬¡å¯¹ç«¯æœ‰å†™å…¥æ—¶æ‰èƒ½ä¸€èµ·å–å‡ºæ¥äº†ã€‚
            // å½“å¯¹æ–¹å…³é—­è¿æ¥ï¼Œåˆ™æ˜¯EPOLLERRäº‹ä»¶
            if (fd == lfd) {
                printf(&#34;this is accept\n&#34;);
                handleAccept(efd, fd); 
            } else {
                printf(&#34;this can read\n&#34;);
                handleRead(efd, fd);
            }
        } else if (events &amp; EPOLLOUT) {
            // è¿™é‡Œå¤„ç†æ–‡ä»¶æè¿°ç¬¦å¦‚æœå¯ä»¥å†™å…¥çš„äº‹ä»¶
            // EPOLLOUTäº‹ä»¶åªæœ‰åœ¨è¿æ¥æ—¶è§¦å‘ä¸€æ¬¡ï¼Œè¡¨ç¤ºå¯å†™
            // ä¹‹åè¡¨ç¤ºç¼“å†²åŒºçš„æ•°æ®å·²ç»é€å‡ºï¼Œå¯ä»¥ç»§ç»­å†™å…¥
            // è¯¦è§https://www.zhihu.com/question/22840801
            if(output_log) printf(&#34;handling epollout\n&#34;);
            handleWrite(efd, fd);
        } else {
            exit_if(1, &#34;unknown event&#34;);
        }
    }
}

int main(int argc, const char* argv[]) {
    if (argc &gt; 1) { output_log = false; }
    /* 
å°çŸ¥è¯†
signalï¼ˆå‚æ•°1ï¼Œå‚æ•°2ï¼‰ï¼›
å‚æ•°1ï¼šæˆ‘ä»¬è¦è¿›è¡Œå¤„ç†çš„ä¿¡å·ã€‚ç³»ç»Ÿçš„ä¿¡å·æˆ‘ä»¬å¯ä»¥å†ç»ˆç«¯é”®å…¥ kill -læŸ¥çœ‹(å…±64ä¸ª)ã€‚å…¶å®è¿™äº›ä¿¡å·æ—¶ç³»ç»Ÿå®šä¹‰çš„å®ã€‚
å‚æ•°2ï¼šæˆ‘ä»¬å¤„ç†çš„æ–¹å¼ï¼ˆæ˜¯ç³»ç»Ÿé»˜è®¤è¿˜æ˜¯å¿½ç•¥è¿˜æ˜¯æ•è·ï¼‰ã€‚SIG_IGN: å¦‚æœfuncå‚æ•°è¢«è®¾ç½®ä¸ºSIG_IGNï¼Œè¯¥ä¿¡å·å°†è¢«å¿½ç•¥ã€‚
     */
    ::signal(SIGPIPE, SIG_IGN);
    // è®¾ç½®httpè¿”å›çš„å†…å®¹
    httpRes = &#34;HTTP/1.1 200 OK\r\nConnection: Keep-Alive\r\nContent-Type: text/html; charset=UTF-8\r\nContent-Length: 19048576\r\n\r\n123456&#34;;
    // å°†å‰©ä¸‹çš„å†…å®¹å¡«å……æˆ0ã€‚æœ€åcontentçš„é•¿åº¦æ˜¯å¤§çº¦1024*1024
    for(int i=0;i&lt;19048570;i++) {
        httpRes+=&#39;\0&#39;;
    }
    // è®¾ç½®ç«¯å£ä¸º80ç«¯å£
    short port = 80;
    // åˆ›å»ºä¸€ä¸ªepollå¥æŸ„
    int epollfd = epoll_create(1);
    exit_if(epollfd &lt; 0, &#34;epoll_create failed&#34;);
    // åˆ›å»ºä¸€ä¸ªsocketå¥—æ¥å­—
    int listenfd = socket(AF_INET, SOCK_STREAM, 0);
    exit_if(listenfd &lt; 0, &#34;socket failed&#34;);
    struct sockaddr_in addr;
    memset(&amp;addr, 0, sizeof addr);
    addr.sin_family = AF_INET;
    addr.sin_port = htons(port);
    addr.sin_addr.s_addr = INADDR_ANY;
    // å…ˆç»‘å®šsocketåˆ°ç«¯å£ä¸Š
    int r = ::bind(listenfd,(struct sockaddr *)&amp;addr, sizeof(struct sockaddr));
    // è¿™ä¸€æ­¥å¦‚æœæ²¡æœ‰è¶…çº§ç”¨æˆ·çš„æƒé™ï¼Œå°±ä¼šæŠ¥é”™ã€‚linuxå¯¹äºérootæƒé™ç”¨æˆ·ä¸èƒ½ä½¿ç”¨1024ä»¥ä¸‹çš„ç«¯å£
    exit_if(r, &#34;bind to 0.0.0.0:%d failed %d %s&#34;, port, errno, strerror(errno));
    /* 
    #include&lt;sys/socket.h&gt;
int listen(int sockfd, int backlog)
è¿”å›ï¼š0â”€â”€æˆåŠŸï¼Œ -1â”€â”€å¤±è´¥
å‚æ•°sockfd
è¢«listenå‡½æ•°ä½œç”¨çš„å¥—æ¥å­—ï¼Œsockfdä¹‹å‰ç”±socketå‡½æ•°è¿”å›ã€‚åœ¨è¢«socketå‡½æ•°è¿”å›çš„å¥—æ¥å­—fdä¹‹æ—¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸»åŠ¨è¿æ¥çš„å¥—æ¥å­—ï¼Œ
ä¹Ÿå°±æ˜¯æ­¤æ—¶ç³»ç»Ÿå‡è®¾ç”¨æˆ·ä¼šå¯¹è¿™ä¸ªå¥—æ¥å­—è°ƒç”¨connectå‡½æ•°ï¼ŒæœŸå¾…å®ƒä¸»åŠ¨ä¸å…¶å®ƒè¿›ç¨‹è¿æ¥ï¼Œç„¶ååœ¨æœåŠ¡å™¨ç¼–ç¨‹ä¸­ï¼Œç”¨æˆ·å¸Œæœ›è¿™ä¸ªå¥—æ¥å­—å¯ä»¥æ¥å—å¤–æ¥çš„è¿æ¥è¯·æ±‚ï¼Œ
ä¹Ÿå°±æ˜¯è¢«åŠ¨ç­‰å¾…ç”¨æˆ·æ¥è¿æ¥ã€‚ç”±äºç³»ç»Ÿé»˜è®¤æ—¶è®¤ä¸ºä¸€ä¸ªå¥—æ¥å­—æ˜¯ä¸»åŠ¨è¿æ¥çš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡æŸç§æ–¹å¼æ¥å‘Šè¯‰ç³»ç»Ÿï¼Œç”¨æˆ·è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨listenæ¥å®Œæˆè¿™ä»¶äº‹ã€‚
å‚æ•°backlog
è¿™ä¸ªå‚æ•°æ¶‰åŠåˆ°ä¸€äº›ç½‘ç»œçš„ç»†èŠ‚ã€‚åœ¨è¿›ç¨‹æ­£ç†ä¸€ä¸ªä¸€ä¸ªè¿æ¥è¯·æ±‚çš„æ—¶å€™ï¼Œå¯èƒ½è¿˜å­˜åœ¨å…¶å®ƒçš„è¿æ¥è¯·æ±‚ã€‚
å› ä¸ºTCPè¿æ¥æ˜¯ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ‰€ä»¥å¯èƒ½å­˜åœ¨ä¸€ç§åŠè¿æ¥çš„çŠ¶æ€ï¼Œæœ‰æ—¶ç”±äºåŒæ—¶å°è¯•è¿æ¥çš„ç”¨æˆ·è¿‡å¤šï¼Œä½¿å¾—æœåŠ¡å™¨è¿›ç¨‹æ— æ³•å¿«é€Ÿåœ°å®Œæˆè¿æ¥è¯·æ±‚ã€‚
å¦‚æœè¿™ä¸ªæƒ…å†µå‡ºç°äº†ï¼ŒæœåŠ¡å™¨è¿›ç¨‹å¸Œæœ›å†…æ ¸å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ
å†…æ ¸ä¼šåœ¨è‡ªå·±çš„è¿›ç¨‹ç©ºé—´é‡Œç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ä»¥è·Ÿè¸ªè¿™äº›å®Œæˆçš„è¿æ¥ä½†æœåŠ¡å™¨è¿›ç¨‹è¿˜æ²¡æœ‰æ¥æ‰‹å¤„ç†æˆ–æ­£åœ¨è¿›è¡Œçš„è¿æ¥ï¼Œè¿™æ ·çš„ä¸€ä¸ªé˜Ÿåˆ—å†…æ ¸ä¸å¯èƒ½è®©å…¶ä»»æ„å¤§ï¼Œ
æ‰€ä»¥å¿…é¡»æœ‰ä¸€ä¸ªå¤§å°çš„ä¸Šé™ã€‚è¿™ä¸ªbacklogå‘Šè¯‰å†…æ ¸ä½¿ç”¨è¿™ä¸ªæ•°å€¼ä½œä¸ºä¸Šé™ã€‚
æ¯«æ— ç–‘é—®ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ä¸èƒ½éšä¾¿æŒ‡å®šä¸€ä¸ªæ•°å€¼ï¼Œå†…æ ¸æœ‰ä¸€ä¸ªè®¸å¯çš„èŒƒå›´ã€‚è¿™ä¸ªèŒƒå›´æ˜¯å®ç°ç›¸å…³çš„ã€‚å¾ˆéš¾æœ‰æŸç§ç»Ÿä¸€ï¼Œä¸€èˆ¬è¿™ä¸ªå€¼ä¼šå°30ä»¥å†…ã€‚
å†…æ ¸ç”¨äºè·Ÿè¸ªè¿™äº›å®Œæˆè¿æ¥ä½†æ˜¯ç”¨æˆ·ä»£ç è¿˜æ²¡æœ‰é€šè¿‡acceptè°ƒç”¨çš„é˜Ÿåˆ—é•¿åº¦è¿™é‡Œè®¾ç½®ä¸ºäº†20ã€‚åœ¨é˜Ÿåˆ—é•¿åº¦å°äº20æ—¶ï¼Œå†…æ ¸ä¼šç«‹å³å®Œæˆè¿æ¥çš„å»ºç«‹ã€‚
ä½†æ˜¯å¦‚æœé˜Ÿåˆ—é•¿åº¦å¤§äº20ï¼Œåœ¨ç”¨æˆ·ä»£ç è°ƒç”¨acceptä¹‹å‰è¯¥è¿æ¥éƒ½ä¸ä¼šå»ºç«‹ï¼Œå¯¹æ–¹åˆ™å¤„äºé˜»å¡çŠ¶æ€ã€‚
     */
    r = listen(listenfd, 20);
    exit_if(r, &#34;listen failed %d %s&#34;, errno, strerror(errno));
    printf(&#34;fd %d listening at %d\n&#34;, listenfd, port);
    // æ¥ä¸‹æ¥è®¾ç½®æ–‡ä»¶æè¿°ç¬¦ä¸ºé˜»å¡ã€‚
    // ä¸ºä»€ä¹ˆè¦è®¾ç½®ä¸ºéé˜»å¡ï¼Ÿhttps://www.zhihu.com/question/23614342
    setNonBlock(listenfd);
    // å°†å…¶è®¾ç½®ä¸ºå¯è¯»å–æ—¶è§¦å‘ï¼Œæ·»åŠ åˆ°epollæ–‡ä»¶æè¿°ç¬¦æ± ä¸­
    updateEvents(epollfd, listenfd, EPOLLIN, EPOLL_CTL_ADD);
    for (;;) { //å®é™…åº”ç”¨åº”å½“æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œé€€å‡ºæ—¶æ¸…ç†èµ„æº
        loop_once(epollfd, listenfd, 10000);
    }
    return 0;
}
</code></pre><h2 id="è¿è¡Œæ•ˆæœ">è¿è¡Œæ•ˆæœ
</h2><p><img src="https://upload-images.jianshu.io/upload_images/4388248-57aa370a0545fdb4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"
	
	
	
	loading="lazy"
	
		alt="image.png"
	
	
></p>
<pre tabindex="0"><code>sudo ./epoll
fd 4 listening at 80
add fd 4 events read 1 write 0
epoll_wait return 1
this is accept
accept a connection from 127.0.0.1
add fd 5 events read 1 write 0
epoll_wait return 1
this can read
read 412 bytes
now info is
---GET / HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36
Upgrade-Insecure-Requests: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9,und;q=0.8,zh-TW;q=0.7,en;q=0.6,pl;q=0.5


---
write 4081834 bytes left: 14966851
update it to EPOLLIN|EPOLLOUT
mod fd 5 events read 1 write 4
nothing to read from 5, return.
epoll_wait return 1
handling epollout
write 2226422 bytes left: 12740429
epoll_wait return 1
handling epollout
write 2095456 bytes left: 10644973
epoll_wait return 1
handling epollout
write 1964490 bytes left: 8680483
epoll_wait return 1
handling epollout
write 1506109 bytes left: 7174374
epoll_wait return 1
handling epollout
write 1833524 bytes left: 5340850
epoll_wait return 1
handling epollout
write 1637075 bytes left: 3703775
write 130966 bytes left: 3572809
epoll_wait return 1
handling epollout
write 1571592 bytes left: 2001217
epoll_wait return 1
handling epollout
write 1440626 bytes left: 560591
epoll_wait return 1
handling epollout
write 560591 bytes left: 0
mod fd 5 events read 1 write 0
epoll_wait return 1
this can read
read 375 bytes
now info is
---GET /favicon.ico HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36
Accept: image/webp,image/apng,image/*,*/*;q=0.8
Referer: http://127.0.0.1/
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9,und;q=0.8,zh-TW;q=0.7,en;q=0.6,pl;q=0.5


---
write 10477280 bytes left: 8571405
update it to EPOLLIN|EPOLLOUT
mod fd 5 events read 1 write 4
nothing to read from 5, return.
epoll_wait return 1
handling epollout
write 1440626 bytes left: 7130779
epoll_wait return 1
handling epollout
write 1768041 bytes left: 5362738
epoll_wait return 1
handling epollout
write 1571592 bytes left: 3791146
epoll_wait return 1
handling epollout
write 1637075 bytes left: 2154071
epoll_wait return 1
handling epollout
write 1702558 bytes left: 451513
epoll_wait return 1
handling epollout
write 451513 bytes left: 0
mod fd 5 events read 1 write 0
epoll_wait return 0
epoll_wait return 0
epoll_wait return 0
</code></pre><p>è¿™é‡Œæˆ‘å‘é€çš„èµ„æºæ”¹å¤§äº†ï¼Œæ”¹æˆå¦‚ä¸‹çš„æ•°å€¼ï¼š</p>
<pre tabindex="0"><code>    httpRes = &#34;HTTP/1.1 200 OK\r\nConnection: Keep-Alive\r\nContent-Type: text/html; charset=UTF-8\r\nContent-Length: 19048576\r\n\r\n123456&#34;;
    // å°†å‰©ä¸‹çš„å†…å®¹å¡«å……æˆ0ã€‚æœ€åcontentçš„é•¿åº¦æ˜¯å¤§çº¦1024*1024
    for(int i=0;i&lt;19048570;i++) {
        httpRes+=&#39;\0&#39;;
    }
</code></pre><p>å¯ä»¥çœ‹åˆ°åˆ†äº†å¤šæ¬¡ä¼ è¾“ã€‚æœ€ç»ˆç»ˆç«¯é¡µé¢ä¸Šæ˜¾ç¤º123456ï¼Œåé¢å…¨éƒ½æ˜¯\0ï¼Œä¸ä¼šæ˜¾ç¤ºã€‚
å¯ä»¥çœ‹åˆ°æµè§ˆå™¨è¯·æ±‚äº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡è¯·æ±‚æ ¹ç›®å½•ï¼Œä¸€æ¬¡è¯·æ±‚é¡µé¢çš„å›¾æ ‡favicon.ico</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nansenli" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Nansen Li ğŸŒˆ ï¼ˆææ¥ æ£®ï¼‰
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.31.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
