<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="ÂâçË®Ä C++ÁΩëÁªúÂ∫ìÊúâÂæàÂ§ö„ÄÇhandyÊòØ‰∏Ä‰∏™C++11È£éÊ†ºÁöÑÁΩëÁªúÂ∫ìÔºåÂØπÊ∑±ÂÖ•Â≠¶‰π†C++ÊúâÂæàÂ§ßÂ∏ÆÂä©„ÄÇ ‰ª£Á†ÅÂàÜÊûê ‰∏ãÈù¢ÊòØÊù•Ëá™handy/raw_examples‰∏ãÁöÑepoll.ccÊñá‰ª∂„ÄÇÊòØÊ∞¥Âπ≥Ëß¶ÂèëÁöÑ‰∏Ä‰∏™Á§∫‰æã„ÄÇËØ•httpÊúçÂä°Âô®Êó†ËÆ∫Êé•Êî∂Âà∞‰ªÄ‰πàÊ†∑ÁöÑËØ∑Ê±ÇÔºåÈÉΩËøîÂõû‰∏Ä‰∏™ÈùôÊÄÅËµÑÊ∫ê123456„ÄÇÁºñËØëÔºöc++ -o epoll epoll.ccÔºåËøêË°åÔºö sudo ./epoll„ÄÇÊ∫ê‰ª£Á†Å‰∏≠sendResÁöÑif (con.writeEnabled)ËøôÂè•‰ºº‰πéÊúâ‰∫õÈóÆÈ¢òÔºåÂØºËá¥ÂèëÈÄÅË∂ÖÂ§ßËµÑÊ∫êÊó∂Âá∫Áé∞ÈóÆÈ¢ò„ÄÇÊàëÂ∑≤ÁªèÂÅö‰∫Ü‰øÆÊîπÔºå‰Ωø‰πãËÉΩÂ§üÊ≠£Á°ÆÂèëÈÄÅË∂ÖÂ§ßÊñá‰ª∂„ÄÇ /* * ÁºñËØëÔºöc++ -o epoll epoll.cc * ËøêË°åÔºö ./epoll * ÊµãËØïÔºöcurl -v localhost */ /* ËøêË°åÊïàÊûú ‰ΩøÁî®sudo ËøêË°åepollÁ®ãÂ∫è„ÄÇËØ•Á®ãÂ∫èÂú®Êú¨Êú∫0.0.0.0ÁöÑ80Á´ØÂè£ÁõëÂê¨Ôºå‰Ωú‰∏∫‰∏Ä‰∏™httpÊúçÂä°Âô®ËøêË°å ÊØèÂΩìÊúâËøûÊé•ËÆøÈóÆÊó∂ÔºåËøîÂõûÈùôÊÄÅËµÑÊ∫êhttpRes LTÊòØÈªòËÆ§Ê®°Âºè */ #include &lt;sys/socket.h&gt; #include &lt;sys/epoll.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;map&gt; #include &lt;string&gt; #include &lt;signal.h&gt; #include &lt;iostream&gt; using namespace std; bool output_log = true; // ‰∏Ä‰∏™ÂÆèÔºåÁî®Êù•ÊâìÂç∞ÈîôËØØÂπ∂ÈÄÄÂá∫ #define exit_if(r, .">
<title>epoll‰ª£Á†ÅÁ§∫‰æã‚Äî‚ÄîhandyÂ∫ìËá™Â∏¶epoll.ccÂàÜÊûê</title>

<link rel='canonical' href='https://nansenli.com/zh-cn/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.b9b97e7c3f7f078f7ec4f60195f6139d30ad5972cc05950321ee04a9e98c542f.css"><meta property='og:title' content="epoll‰ª£Á†ÅÁ§∫‰æã‚Äî‚ÄîhandyÂ∫ìËá™Â∏¶epoll.ccÂàÜÊûê">
<meta property='og:description' content="ÂâçË®Ä C++ÁΩëÁªúÂ∫ìÊúâÂæàÂ§ö„ÄÇhandyÊòØ‰∏Ä‰∏™C++11È£éÊ†ºÁöÑÁΩëÁªúÂ∫ìÔºåÂØπÊ∑±ÂÖ•Â≠¶‰π†C++ÊúâÂæàÂ§ßÂ∏ÆÂä©„ÄÇ ‰ª£Á†ÅÂàÜÊûê ‰∏ãÈù¢ÊòØÊù•Ëá™handy/raw_examples‰∏ãÁöÑepoll.ccÊñá‰ª∂„ÄÇÊòØÊ∞¥Âπ≥Ëß¶ÂèëÁöÑ‰∏Ä‰∏™Á§∫‰æã„ÄÇËØ•httpÊúçÂä°Âô®Êó†ËÆ∫Êé•Êî∂Âà∞‰ªÄ‰πàÊ†∑ÁöÑËØ∑Ê±ÇÔºåÈÉΩËøîÂõû‰∏Ä‰∏™ÈùôÊÄÅËµÑÊ∫ê123456„ÄÇÁºñËØëÔºöc++ -o epoll epoll.ccÔºåËøêË°åÔºö sudo ./epoll„ÄÇÊ∫ê‰ª£Á†Å‰∏≠sendResÁöÑif (con.writeEnabled)ËøôÂè•‰ºº‰πéÊúâ‰∫õÈóÆÈ¢òÔºåÂØºËá¥ÂèëÈÄÅË∂ÖÂ§ßËµÑÊ∫êÊó∂Âá∫Áé∞ÈóÆÈ¢ò„ÄÇÊàëÂ∑≤ÁªèÂÅö‰∫Ü‰øÆÊîπÔºå‰Ωø‰πãËÉΩÂ§üÊ≠£Á°ÆÂèëÈÄÅË∂ÖÂ§ßÊñá‰ª∂„ÄÇ /* * ÁºñËØëÔºöc++ -o epoll epoll.cc * ËøêË°åÔºö ./epoll * ÊµãËØïÔºöcurl -v localhost */ /* ËøêË°åÊïàÊûú ‰ΩøÁî®sudo ËøêË°åepollÁ®ãÂ∫è„ÄÇËØ•Á®ãÂ∫èÂú®Êú¨Êú∫0.0.0.0ÁöÑ80Á´ØÂè£ÁõëÂê¨Ôºå‰Ωú‰∏∫‰∏Ä‰∏™httpÊúçÂä°Âô®ËøêË°å ÊØèÂΩìÊúâËøûÊé•ËÆøÈóÆÊó∂ÔºåËøîÂõûÈùôÊÄÅËµÑÊ∫êhttpRes LTÊòØÈªòËÆ§Ê®°Âºè */ #include &lt;sys/socket.h&gt; #include &lt;sys/epoll.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;map&gt; #include &lt;string&gt; #include &lt;signal.h&gt; #include &lt;iostream&gt; using namespace std; bool output_log = true; // ‰∏Ä‰∏™ÂÆèÔºåÁî®Êù•ÊâìÂç∞ÈîôËØØÂπ∂ÈÄÄÂá∫ #define exit_if(r, .">
<meta property='og:url' content='https://nansenli.com/zh-cn/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/'>
<meta property='og:site_name' content='Nansen Li&#39;s Blog
ÊùéÊ•†Ê£ÆÁöÑÂçöÂÆ¢
'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2018-05-16T07:43:00&#43;00:00'/><meta property='article:modified_time' content='2018-05-16T07:43:00&#43;00:00'/>
<meta name="twitter:title" content="epoll‰ª£Á†ÅÁ§∫‰æã‚Äî‚ÄîhandyÂ∫ìËá™Â∏¶epoll.ccÂàÜÊûê">
<meta name="twitter:description" content="ÂâçË®Ä C++ÁΩëÁªúÂ∫ìÊúâÂæàÂ§ö„ÄÇhandyÊòØ‰∏Ä‰∏™C++11È£éÊ†ºÁöÑÁΩëÁªúÂ∫ìÔºåÂØπÊ∑±ÂÖ•Â≠¶‰π†C++ÊúâÂæàÂ§ßÂ∏ÆÂä©„ÄÇ ‰ª£Á†ÅÂàÜÊûê ‰∏ãÈù¢ÊòØÊù•Ëá™handy/raw_examples‰∏ãÁöÑepoll.ccÊñá‰ª∂„ÄÇÊòØÊ∞¥Âπ≥Ëß¶ÂèëÁöÑ‰∏Ä‰∏™Á§∫‰æã„ÄÇËØ•httpÊúçÂä°Âô®Êó†ËÆ∫Êé•Êî∂Âà∞‰ªÄ‰πàÊ†∑ÁöÑËØ∑Ê±ÇÔºåÈÉΩËøîÂõû‰∏Ä‰∏™ÈùôÊÄÅËµÑÊ∫ê123456„ÄÇÁºñËØëÔºöc++ -o epoll epoll.ccÔºåËøêË°åÔºö sudo ./epoll„ÄÇÊ∫ê‰ª£Á†Å‰∏≠sendResÁöÑif (con.writeEnabled)ËøôÂè•‰ºº‰πéÊúâ‰∫õÈóÆÈ¢òÔºåÂØºËá¥ÂèëÈÄÅË∂ÖÂ§ßËµÑÊ∫êÊó∂Âá∫Áé∞ÈóÆÈ¢ò„ÄÇÊàëÂ∑≤ÁªèÂÅö‰∫Ü‰øÆÊîπÔºå‰Ωø‰πãËÉΩÂ§üÊ≠£Á°ÆÂèëÈÄÅË∂ÖÂ§ßÊñá‰ª∂„ÄÇ /* * ÁºñËØëÔºöc++ -o epoll epoll.cc * ËøêË°åÔºö ./epoll * ÊµãËØïÔºöcurl -v localhost */ /* ËøêË°åÊïàÊûú ‰ΩøÁî®sudo ËøêË°åepollÁ®ãÂ∫è„ÄÇËØ•Á®ãÂ∫èÂú®Êú¨Êú∫0.0.0.0ÁöÑ80Á´ØÂè£ÁõëÂê¨Ôºå‰Ωú‰∏∫‰∏Ä‰∏™httpÊúçÂä°Âô®ËøêË°å ÊØèÂΩìÊúâËøûÊé•ËÆøÈóÆÊó∂ÔºåËøîÂõûÈùôÊÄÅËµÑÊ∫êhttpRes LTÊòØÈªòËÆ§Ê®°Âºè */ #include &lt;sys/socket.h&gt; #include &lt;sys/epoll.h&gt; #include &lt;netinet/in.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;fcntl.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;errno.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;map&gt; #include &lt;string&gt; #include &lt;signal.h&gt; #include &lt;iostream&gt; using namespace std; bool output_log = true; // ‰∏Ä‰∏™ÂÆèÔºåÁî®Êù•ÊâìÂç∞ÈîôËØØÂπ∂ÈÄÄÂá∫ #define exit_if(r, .">
    <link rel="shortcut icon" href="/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-WC38C3XE3J"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-WC38C3XE3J');
        }
      </script>
    
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/zh-cn/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu96777ff80939aaa7d938dddcc232fcc6_1414962_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üåà</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/zh-cn">Nansen Li&#39;s Blog
ÊùéÊ•†Ê£ÆÁöÑÂçöÂÆ¢
</a></h1>
            <h2 class="site-description"></h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/linanwx'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://www.linkedin.com/in/nansen-li-3bb0a3146/'
                        target="_blank"
                        title="LinkedIn"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 11v5" /><path d="M8 8v.01" /><path d="M12 16v-5" /><path d="M16 16v-3a2 2 0 1 0 -4 0" /><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/zh-cn/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://nansenli.com/" >English</option>
                                
                                    <option value="https://nansenli.com/zh-cn/" selected>‰∏≠Êñá</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/zh-cn/categories/%E7%BD%91%E7%BB%9C/" >
                ÁΩëÁªú
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/zh-cn/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/">epoll‰ª£Á†ÅÁ§∫‰æã‚Äî‚ÄîhandyÂ∫ìËá™Â∏¶epoll.ccÂàÜÊûê</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">May 16, 2018</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 6 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
        <footer class="article-translations">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



            <div>
                
                    <a href="https://nansenli.com/post/jianshu/%E7%BD%91%E7%BB%9C/epoll%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8Bhandy%E5%BA%93%E8%87%AA%E5%B8%A6epoll-cc%E5%88%86%E6%9E%90/" class="link">English</a>
                
            </div>
        </footer>
    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="ÂâçË®Ä">ÂâçË®Ä
</h2><p>C++ÁΩëÁªúÂ∫ìÊúâÂæàÂ§ö„ÄÇhandyÊòØ‰∏Ä‰∏™C++11È£éÊ†ºÁöÑÁΩëÁªúÂ∫ìÔºåÂØπÊ∑±ÂÖ•Â≠¶‰π†C++ÊúâÂæàÂ§ßÂ∏ÆÂä©„ÄÇ</p>
<h2 id="‰ª£Á†ÅÂàÜÊûê">‰ª£Á†ÅÂàÜÊûê
</h2><p>‰∏ãÈù¢ÊòØÊù•Ëá™handy/raw_examples‰∏ãÁöÑepoll.ccÊñá‰ª∂„ÄÇÊòØÊ∞¥Âπ≥Ëß¶ÂèëÁöÑ‰∏Ä‰∏™Á§∫‰æã„ÄÇËØ•httpÊúçÂä°Âô®Êó†ËÆ∫Êé•Êî∂Âà∞‰ªÄ‰πàÊ†∑ÁöÑËØ∑Ê±ÇÔºåÈÉΩËøîÂõû‰∏Ä‰∏™ÈùôÊÄÅËµÑÊ∫ê123456„ÄÇÁºñËØëÔºöc++ -o epoll epoll.ccÔºåËøêË°åÔºö sudo ./epoll„ÄÇÊ∫ê‰ª£Á†Å‰∏≠sendResÁöÑif (con.writeEnabled)ËøôÂè•‰ºº‰πéÊúâ‰∫õÈóÆÈ¢òÔºåÂØºËá¥ÂèëÈÄÅË∂ÖÂ§ßËµÑÊ∫êÊó∂Âá∫Áé∞ÈóÆÈ¢ò„ÄÇÊàëÂ∑≤ÁªèÂÅö‰∫Ü‰øÆÊîπÔºå‰Ωø‰πãËÉΩÂ§üÊ≠£Á°ÆÂèëÈÄÅË∂ÖÂ§ßÊñá‰ª∂„ÄÇ</p>
<pre tabindex="0"><code>/*
 * ÁºñËØëÔºöc++ -o epoll epoll.cc
 * ËøêË°åÔºö ./epoll
 * ÊµãËØïÔºöcurl -v localhost
 */


/* 
    ËøêË°åÊïàÊûú
    ‰ΩøÁî®sudo ËøêË°åepollÁ®ãÂ∫è„ÄÇËØ•Á®ãÂ∫èÂú®Êú¨Êú∫0.0.0.0ÁöÑ80Á´ØÂè£ÁõëÂê¨Ôºå‰Ωú‰∏∫‰∏Ä‰∏™httpÊúçÂä°Âô®ËøêË°å
    ÊØèÂΩìÊúâËøûÊé•ËÆøÈóÆÊó∂ÔºåËøîÂõûÈùôÊÄÅËµÑÊ∫êhttpRes
    LTÊòØÈªòËÆ§Ê®°Âºè

 */

#include &lt;sys/socket.h&gt;
#include &lt;sys/epoll.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;map&gt;
#include &lt;string&gt;
#include &lt;signal.h&gt;
#include &lt;iostream&gt;
using namespace std;


bool output_log = true;
// ‰∏Ä‰∏™ÂÆèÔºåÁî®Êù•ÊâìÂç∞ÈîôËØØÂπ∂ÈÄÄÂá∫
#define exit_if(r, ...) if(r) {printf(__VA_ARGS__); printf(&#34;%s:%d error no: %d error msg %s\n&#34;, __FILE__, __LINE__, errno, strerror(errno)); exit(1);}
// Ëøô‰∏™ÂáΩÊï∞Áî®‰∫éÂ∞ÜÊåáÂÆöÁöÑfdËÆæÁΩÆ‰∏∫ÈùûÈòªÂ°ûÁä∂ÊÄÅ
void setNonBlock(int fd) {
    // È¶ñÂÖàÊàë‰ª¨ÂèñÂá∫ÂéüÊù•Êñá‰ª∂ÊèèËø∞Á¨¶ÁöÑflags
    int flags = fcntl(fd, F_GETFL, 0);
    exit_if(flags&lt;0, &#34;fcntl failed&#34;);
    // ÁÑ∂ÂêéÂä†‰∏äO_NONBLOCKÔºåÂÜçËÆæÁΩÆÂõûÂéª
    int r = fcntl(fd, F_SETFL, flags | O_NONBLOCK);
    exit_if(r&lt;0, &#34;fcntl failed&#34;);
}
// ÂØπepoll_ctl‰∫åÊ¨°ÂåÖË£ÖÔºåÂ∞Üevents Âíå fdÊîæÂÖ•ev‰∏≠„ÄÇ
// Âπ∂‰∏îËÆæÁΩÆevents ËÆæÁΩÆ‰∏∫ÂèØËØªÂèØÂÜôÊó∂Ëß¶Âèë
void updateEvents(int efd, int fd, int events, int op) {
    struct epoll_event ev = {0};
    ev.events = events;
    ev.data.fd = fd;
    printf(&#34;%s fd %d events read %d write %d\n&#34;,
           op==EPOLL_CTL_MOD?&#34;mod&#34;:&#34;add&#34;, fd, ev.events &amp; EPOLLIN, ev.events &amp; EPOLLOUT);
    int r = epoll_ctl(efd, op, fd, &amp;ev);
    exit_if(r, &#34;epoll_ctl failed&#34;);
}
// Â∞ùËØïÂú®fd‰∏äÂÅöacceptÊìç‰Ωú„ÄÇÂ¶ÇÊûúÊàêÂäüÔºåÂ∞ÜÂÖ∂Âä†ÂÖ•Âà∞epoll fdÁöÑÁõëÂê¨ÂàóË°®‰∏≠„ÄÇepollÁöÑeventsËÆæÁΩÆ‰∏∫ÂΩìÊï∞ÊçÆÊúâÂÜôÂÖ•ÁöÑÊó∂ÂÄôËß¶Âèë„ÄÇ
void handleAccept(int efd, int fd) {
    struct sockaddr_in raddr;
    socklen_t rsz = sizeof(raddr);
    int cfd = accept(fd,(struct sockaddr *)&amp;raddr,&amp;rsz);
    exit_if(cfd&lt;0, &#34;accept failed&#34;);
    sockaddr_in peer, local;
    socklen_t alen = sizeof(peer);
    int r = getpeername(cfd, (sockaddr*)&amp;peer, &amp;alen);
    exit_if(r&lt;0, &#34;getpeername failed&#34;);
    printf(&#34;accept a connection from %s\n&#34;, inet_ntoa(raddr.sin_addr));
    setNonBlock(cfd);
    updateEvents(efd, cfd, EPOLLIN, EPOLL_CTL_ADD);
}
// Ë°®Á§∫‰∏Ä‰∏™ËøûÊé•„ÄÇÊàêÂëòÊúâËøûÊé•Â∑≤ËØªÂèñÁöÑÊï∞ÊçÆ„ÄÅÂ∑≤ÂÜôÂÖ•ÁöÑÊï∞ÊçÆ
// stringÁî®Êù•‰øùÂ≠ò‰∫åËøõÂà∂ÂÜÖÂÆπÊ≤°ÊúâÈóÆÈ¢òÂêóÔºåÂ¶ÇÊûúÈÅáÂà∞\0‰ºöÂ¶Ç‰ΩïÔºü
// Ê≤°ÊúâÈóÆÈ¢òhttps://www.zhihu.com/question/33104941
struct Con {
    string readed;
    size_t written;
    bool writeEnabled;
    Con(): written(0), writeEnabled(false) {}
};
// Áî®Êù•Êò†Â∞Ñfd‰∏éconÁöÑÊï∞ÊçÆÁªìÊûÑ
map&lt;int, Con&gt; cons;

string httpRes;
// ÂèëÈÄÅËµÑÊ∫ê
void sendRes(int efd, int fd) {
    // È¶ñÂÖàÂèñÂæóËøûÊé•‰ø°ÊÅØ
    Con&amp; con = cons[fd];
    // Ê≤°ÊúâÊé•ÂèóÂà∞Êï∞ÊçÆÂ∞±Ë¶ÅÊ±ÇÂÜôÂÖ•
    // ËØ¥ÊòéÂÖ∂ÂèØËÉΩ‰∏ä‰∏ÄÊ¨°ÁªßÁª≠ÂèëÈÄÅÁöÑÊï∞ÊçÆÂèëÈÄÅÂÆå‰∫Ü
    // ÂÖ∂ÂØπÂ∫îÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶Âú®cons‰∏≠Â∑≤ÁªèÂà†Èô§
    // ÁÑ∂ÂêéËß¶Âèë‰∫Üepoll‰ø°Âè∑
    // Ê≠§Êó∂ÂÖ≥Èó≠ÂÖ∂‰∏ä‰∏ÄÊ¨°ÂèëÈÄÅÁöÑÊ†áÂøó
    // ÁÑ∂ÂêéÂÖ≥Èó≠ÂÖ∂ÁºìÂÜ≤Âå∫ÂèëÈÄÅËß¶ÂèëepollÁöÑÊ†áÂøó
    // Âè™‰øùÁïôÂÖ∂ÊúâÊï∞ÊçÆÂèØËØªÊó∂Ëß¶Âèë
    // ‰∏∫‰ªÄ‰πà‰∏çÂú®ÂÜôÂÖ•ÂÆåÊï∞ÊçÆÊó∂Â∞±Â∞ÜËøôÊ≠•ÂÅö‰∫ÜÂë¢Ôºü
    // if (!con.readed.length()) {
    //     if (con.writeEnabled) {
    //         updateEvents(efd, fd, EPOLLIN, EPOLL_CTL_MOD);
    //         con.writeEnabled = false;
    //     }
    //     return;
    // }
    // ËÆ°ÁÆóËøòÈúÄË¶ÅÂÜôÂÖ•ÁöÑÊï∞ÊçÆÈïøÂ∫¶
    size_t left = httpRes.length() - con.written;
    int wd = 0;
    // ËøûÁª≠ÂÜôÂÖ•Êï∞ÊçÆÔºåÁõ¥Âà∞ÂÜÖÊ†∏ÁºìÂÜ≤Âå∫Êó†Ê≥ïÂÜôÂÖ•Êï∞ÊçÆ‰∏∫Ê≠¢
    while((wd=::write(fd, httpRes.data()+con.written, left))&gt;0) {
        con.written += wd;
        left -= wd;
        if(output_log) printf(&#34;write %d bytes left: %lu\n&#34;, wd, left);
    };
    // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÂèØ‰ª•ÂÜôÂÖ•ÔºåÂàôÂà†Èô§Ëøô‰∏™ËøûÊé•„ÄÇ‰ΩÜÊòØ‰∏çÊñ≠ÂºÄËøûÊé•ÔºåÂç≥Â∞ÜËøûÊé•‰ø°ÊÅØÁΩÆÁ©∫
    if (left == 0) {
//        close(fd); // ÊµãËØï‰∏≠‰ΩøÁî®‰∫ÜkeepaliveÔºåÂõ†Ê≠§‰∏çÂÖ≥Èó≠ËøûÊé•„ÄÇËøûÊé•‰ºöÂú®read‰∫ã‰ª∂‰∏≠ÂÖ≥Èó≠
        if (con.writeEnabled) {
            updateEvents(efd, fd, EPOLLIN, EPOLL_CTL_MOD);
            con.writeEnabled = false;
        }
        cons.erase(fd);
        return;
    }
    // Â¶ÇÊûúÂÜÖÊ†∏ÁºìÂÜ≤Âå∫Êª°‰∫ÜÔºåÊ≤°ÂäûÊ≥ïÂÜôÂÖ•‰∫Ü
    if (wd &lt; 0 &amp;&amp;  (errno == EAGAIN || errno == EWOULDBLOCK)) {
        // Â∞ÜÂÖ∂Ê†áËÆ∞‰∏äÂèØÁªßÁª≠ÂÜô
        if (!con.writeEnabled) {
            // Á≠âÂæÖÂÖ∂ÂèØÁªßÁª≠ÂÜôÔºåÊàñÂèØËØª
            // ÈÅøÂÖçÈáçÂ§çËøõË°åÁ≥ªÁªüË∞ÉÁî®Ôºå‰ΩøÁî®con.writeEnabledÊ†áËÆ∞‰Ωç
            printf(&#34;update it to EPOLLIN|EPOLLOUT\n&#34;);
            updateEvents(efd, fd, EPOLLIN|EPOLLOUT, EPOLL_CTL_MOD);
            con.writeEnabled = true;
        }
        return;
    }
    // Â¶ÇÊûúÊòØÂÖ∂‰ªñÊÉÖÂÜµÔºåÊØîÂ¶ÇÂú®Ê≤°ÊúâÂÜôÂÆåÊï∞ÊçÆÊó∂Áõ¥Êé•ËøîÂõû0ÔºåÊàñËÄÖÊòØËøîÂõû‰∫ÜÂÖ∂‰ªñÈîôËØØ
    // ÂàôËØ¥ÊòéÂá∫Èîô‰∫Ü
    if (wd&lt;=0) {
        printf(&#34;write error for %d: %d %s\n&#34;, fd, errno, strerror(errno));
        close(fd);
        cons.erase(fd);
    }
}
// ÂΩìloop onceÂ§ÑÁêÜËØªÂèñÊï∞ÊçÆÊó∂ÔºåË∞ÉÁî®ËØ•ÂáΩÊï∞
void handleRead(int efd, int fd) {
    char buf[4096];
    int n = 0;
    // ÊØèÊ¨°ËØªÂèñ4kÂ≠óËäÇÔºåÂæ™ÁéØËØªÂá∫ÂΩìÂâçÂÜÖÊ†∏‰∏≠Â∑≤Â≠òÂú®ÁöÑÊï∞ÊçÆÔºàÊúâÂèØËÉΩÂàÜÂåÖÂØºËá¥‰ø°ÊÅØ‰∏çÂÆåÊï¥Ôºâ
    while ((n=::read(fd, buf, sizeof buf)) &gt; 0) {
        if(output_log) printf(&#34;read %d bytes\n&#34;, n);
        // ËøôÈáåÈÄöËøá‰∏Ä‰∏™mapÊù•Ëé∑Âèñ‰πãÂâçfdÂØπÂ∫îÁöÑËøûÊé•‰ø°ÊÅØ„ÄÇ
        // ÂΩìfdÂØπÂ∫îÁöÑ‰∏ãÊ†á‰∏çÂ≠òÂú®ÁöÑÊó∂ÂÄôÔºåÂàô‰ºöË∞ÉÁî®conÁöÑÈªòËÆ§ÊûÑÈÄ†ÂáΩÊï∞Con(): written(0), writeEnabled(false) {}
        string&amp; readed = cons[fd].readed;
        // Ë∞ÉÁî®stringÁ±ªÁöÑappendÊñπÊ≥ïÂ∞ÜÊï∞ÊçÆÂä†ÂÖ•Âà∞ËøûÊé•‰ø°ÊÅØ‰∏≠
        // Ê≥®ÊÑè‰∏∫‰∫Ü‰øùËØÅ‰∫åËøõÂà∂ÂÆâÂÖ®ÈúÄË¶Å‰º†ÂÖ•ÂèÇÊï∞n
        readed.append(buf, n);
        std::cout  &lt;&lt; &#34;now info is&#34; &lt;&lt; std::endl &lt;&lt; &#34;---&#34; &lt;&lt;  readed &lt;&lt; endl &lt;&lt; &#34;---&#34; &lt;&lt;  std::endl;
        // Âà§Êñ≠‰∏Ä‰∏™httpËØ∑Ê±ÇÂèëÈÄÅÂÆåÊØï„ÄÇ
        // ‰∏çÂà§Êñ≠httpËØ∑Ê±ÇÁöÑÂÜÖÂÆπÔºå‰∏ÄÂæãÂèëÈÄÅÈùôÊÄÅËµÑÊ∫ê
        if (readed.length()&gt;4) {
            if (readed.substr(readed.length()-2, 2) == &#34;\n\n&#34; || readed.substr(readed.length()-4, 4) == &#34;\r\n\r\n&#34;) {
                //ÂΩìËØªÂèñÂà∞‰∏Ä‰∏™ÂÆåÊï¥ÁöÑhttpËØ∑Ê±ÇÔºåÊµãËØïÂèëÈÄÅÂìçÂ∫î
                // TCPËøûÊé•Âª∫Á´ãËµ∑Êù•‰πãÂêéÔºåÂÆ¢Êà∑Á´ØÂ∞±ÂºÄÂßã‰º†ËæìÈ¶ñÈÉ®ÔºåÁÑ∂Âêé‰ª•\r\n\r\nÊù•Ê†áÂøóÈ¶ñÈÉ®ÁöÑÁªìÊùüÂíåÂÆû‰ΩìÁöÑÂºÄÂßãÔºàÂΩìÁÑ∂ÊòØËØ∑Ê±ÇÈáåÂåÖÂê´ÂÆû‰ΩìÊâç‰ºöÊúâÂÆû‰ΩìÁöÑÂºÄÂßãÔºâÔºå
                // Êé•‰∏ãÊù•Â∞±ÊòØÂÆû‰ΩìÁöÑ‰º†ËæìÔºåÂΩìÂÆû‰Ωì‰º†ËæìÂÆå‰πãÂêéÔºåÂÆ¢Êà∑Á´ØÂ∞±ÂºÄÂßãÊé•Êî∂Êï∞ÊçÆÔºåÊúçÂä°Âô®Â∞±Áü•ÈÅìÔºåËøôÊ¨°ËØ∑Ê±ÇÂ∞±Â∑≤ÁªèÁªìÊùü‰∫ÜÔºå
                // ÈÇ£‰πàÂÆû‰ΩìÂ∞±ÊòØ\r\n\r\nÂà∞ÂÅúÊ≠¢Êé•Êî∂ÁöÑÈÇ£‰πà‰∏ÄÊÆµÊï∞ÊçÆ„ÄÇÂØπÂ∫îÁöÑÔºåÂÆ¢Êà∑Á´ØÊé•Êî∂ÂìçÂ∫îÁöÑÊó∂ÂÄô‰πüÊòØËøôÊ†∑„ÄÇ
                // Ê≤°ÊúâÂÆû‰ΩìÔºåÂàô\r\n\r\nÂ∞±ÊòØhttpÁöÑÁªìÊùü
                // ÂºÄÂßãÂÜôÂÖ•Êï∞ÊçÆ„ÄÇÊ≥®ÊÑèÊúâÂèØËÉΩ‰ΩøÁºìÂÜ≤Âå∫ÂÜôÊª°ÔºåËã•ÂÜôÊª°‰∫ÜÂàôÂú®‰πãÂêéÁªßÁª≠ÂÜôÂÖ•
                sendRes(efd, fd);
            }
        }
    }
    // readÊó†Ê≥ïËØªÂèñÁöÑËØùÔºåÂ∞±‰ºöËøîÂõû-1„ÄÇÊ≠§Êó∂errnoÔºàerrnoÊòØÂ±û‰∫éÁ∫øÁ®ãÁöÑÔºåÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÔºâÊòØEAGAIN‰ª£Ë°®Ê≤°ËØªÂÆå„ÄÇEWOULDBLOCKÂíåEAGAINÊòØ‰∏ÄÊ†∑ÁöÑ„ÄÇ
    // ÈÇ£Â∞±ËøîÂõûÔºåÁÑ∂ÂêéÁ≠âÂæÖ‰∏ãÊ¨°ÂÜçËØªÂèñ
    if (n&lt;0 &amp;&amp; (errno == EAGAIN || errno == EWOULDBLOCK)){
        printf(&#34;nothing to read from %d, return. \n&#34;, fd);
        return;
    }
    //ÂÆûÈôÖÂ∫îÁî®‰∏≠Ôºån&lt;0Â∫îÂΩìÊ£ÄÊü•ÂêÑÁ±ªÈîôËØØÔºåÂ¶ÇEINTR
    if (n &lt; 0) {
        printf(&#34;read %d error: %d %s\n&#34;, fd, errno, strerror(errno));
    }
    // ÊâßË°åÂà∞ËøôÈáåÔºånÊòØ0ÔºåË°®Á§∫ÂØπÁ´ØÂÖ≥Èó≠ËøûÊé•„ÄÇËøôÊó∂Êàë‰ª¨‰πüÂÖ≥Èó≠ËøûÊé•
    printf(&#34;%d close the connection\n&#34;, fd);
    close(fd);
    cons.erase(fd);
}
// ÂΩìloop onceÁºìÂÜ≤Âå∫ÂèØÂÜôÁöÑÊó∂ÂÄôÔºåÁÆÄÂçïÁöÑÂÜôÂÖ•Êàë‰ª¨ÂáÜÂ§áÂ•ΩÁöÑÈùôÊÄÅËµÑÊ∫ê
void handleWrite(int efd, int fd) {
    sendRes(efd, fd);
}
// ÂØπ‰∏Ä‰∏™epollÂè•ÊüÑËøõË°åÂæ™ÁéØ‰∏≠ÁöÑ‰∏ÄÊ¨°Êìç‰Ωú
// ÂÖ∂‰∏≠lÊòØLISTENÁöÑfd
void loop_once(int efd, int lfd, int waitms) {
    // ÊúÄÂ§öËÆ©ÂÜÖÊ†∏Êã∑Ë¥ù20‰∏™‰∫ã‰ª∂Âá∫Êù•
    const int kMaxEvents = 20;
    struct epoll_event activeEvs[100];
    int n = epoll_wait(efd, activeEvs, kMaxEvents, waitms);
    // nÊòØËøîÂõû‰∫ÜÂ§öÂ∞ë‰∏™‰∫ã‰ª∂
    if(output_log) printf(&#34;epoll_wait return %d\n&#34;, n);
    for (int i = 0; i &lt; n; i ++) {
        int fd = activeEvs[i].data.fd;
        int events = activeEvs[i].events;
        // EPOLLIN ‰∫ã‰ª∂ÊàñËÄÖÊòØ EPOLLERR‰∫ã‰ª∂„ÄÇEPOLLERR‰πü‰ª£Ë°®ÁÆ°ÈÅìÂÜôÂÖ•ÁªìÊùü„ÄÇ
        // ÂèÇËßÅÔºö http://man7.org/linux/man-pages/man2/epoll_ctl.2.html
        if (events &amp; (EPOLLIN | EPOLLERR)) {
            // EPOLLIN‰∫ã‰ª∂ÂàôÂè™ÊúâÂΩìÂØπÁ´ØÊúâÊï∞ÊçÆÂÜôÂÖ•Êó∂Êâç‰ºöËß¶ÂèëÔºåÊâÄ‰ª•Ëß¶Âèë‰∏ÄÊ¨°ÂêéÈúÄË¶Å‰∏çÊñ≠ËØªÂèñÊâÄÊúâÊï∞ÊçÆÁõ¥Âà∞ËØªÂÆåEAGAIN‰∏∫Ê≠¢„ÄÇÂê¶ÂàôÂâ©‰∏ãÁöÑÊï∞ÊçÆÂè™ÊúâÂú®‰∏ãÊ¨°ÂØπÁ´ØÊúâÂÜôÂÖ•Êó∂ÊâçËÉΩ‰∏ÄËµ∑ÂèñÂá∫Êù•‰∫Ü„ÄÇ
            // ÂΩìÂØπÊñπÂÖ≥Èó≠ËøûÊé•ÔºåÂàôÊòØEPOLLERR‰∫ã‰ª∂
            if (fd == lfd) {
                printf(&#34;this is accept\n&#34;);
                handleAccept(efd, fd); 
            } else {
                printf(&#34;this can read\n&#34;);
                handleRead(efd, fd);
            }
        } else if (events &amp; EPOLLOUT) {
            // ËøôÈáåÂ§ÑÁêÜÊñá‰ª∂ÊèèËø∞Á¨¶Â¶ÇÊûúÂèØ‰ª•ÂÜôÂÖ•ÁöÑ‰∫ã‰ª∂
            // EPOLLOUT‰∫ã‰ª∂Âè™ÊúâÂú®ËøûÊé•Êó∂Ëß¶Âèë‰∏ÄÊ¨°ÔºåË°®Á§∫ÂèØÂÜô
            // ‰πãÂêéË°®Á§∫ÁºìÂÜ≤Âå∫ÁöÑÊï∞ÊçÆÂ∑≤ÁªèÈÄÅÂá∫ÔºåÂèØ‰ª•ÁªßÁª≠ÂÜôÂÖ•
            // ËØ¶ËßÅhttps://www.zhihu.com/question/22840801
            if(output_log) printf(&#34;handling epollout\n&#34;);
            handleWrite(efd, fd);
        } else {
            exit_if(1, &#34;unknown event&#34;);
        }
    }
}

int main(int argc, const char* argv[]) {
    if (argc &gt; 1) { output_log = false; }
    /* 
Â∞èÁü•ËØÜ
signalÔºàÂèÇÊï∞1ÔºåÂèÇÊï∞2ÔºâÔºõ
ÂèÇÊï∞1ÔºöÊàë‰ª¨Ë¶ÅËøõË°åÂ§ÑÁêÜÁöÑ‰ø°Âè∑„ÄÇÁ≥ªÁªüÁöÑ‰ø°Âè∑Êàë‰ª¨ÂèØ‰ª•ÂÜçÁªàÁ´ØÈîÆÂÖ• kill -lÊü•Áúã(ÂÖ±64‰∏™)„ÄÇÂÖ∂ÂÆûËøô‰∫õ‰ø°Âè∑Êó∂Á≥ªÁªüÂÆö‰πâÁöÑÂÆè„ÄÇ
ÂèÇÊï∞2ÔºöÊàë‰ª¨Â§ÑÁêÜÁöÑÊñπÂºèÔºàÊòØÁ≥ªÁªüÈªòËÆ§ËøòÊòØÂøΩÁï•ËøòÊòØÊçïËé∑Ôºâ„ÄÇSIG_IGN: Â¶ÇÊûúfuncÂèÇÊï∞Ë¢´ËÆæÁΩÆ‰∏∫SIG_IGNÔºåËØ•‰ø°Âè∑Â∞ÜË¢´ÂøΩÁï•„ÄÇ
     */
    ::signal(SIGPIPE, SIG_IGN);
    // ËÆæÁΩÆhttpËøîÂõûÁöÑÂÜÖÂÆπ
    httpRes = &#34;HTTP/1.1 200 OK\r\nConnection: Keep-Alive\r\nContent-Type: text/html; charset=UTF-8\r\nContent-Length: 19048576\r\n\r\n123456&#34;;
    // Â∞ÜÂâ©‰∏ãÁöÑÂÜÖÂÆπÂ°´ÂÖÖÊàê0„ÄÇÊúÄÂêécontentÁöÑÈïøÂ∫¶ÊòØÂ§ßÁ∫¶1024*1024
    for(int i=0;i&lt;19048570;i++) {
        httpRes+=&#39;\0&#39;;
    }
    // ËÆæÁΩÆÁ´ØÂè£‰∏∫80Á´ØÂè£
    short port = 80;
    // ÂàõÂª∫‰∏Ä‰∏™epollÂè•ÊüÑ
    int epollfd = epoll_create(1);
    exit_if(epollfd &lt; 0, &#34;epoll_create failed&#34;);
    // ÂàõÂª∫‰∏Ä‰∏™socketÂ•óÊé•Â≠ó
    int listenfd = socket(AF_INET, SOCK_STREAM, 0);
    exit_if(listenfd &lt; 0, &#34;socket failed&#34;);
    struct sockaddr_in addr;
    memset(&amp;addr, 0, sizeof addr);
    addr.sin_family = AF_INET;
    addr.sin_port = htons(port);
    addr.sin_addr.s_addr = INADDR_ANY;
    // ÂÖàÁªëÂÆösocketÂà∞Á´ØÂè£‰∏ä
    int r = ::bind(listenfd,(struct sockaddr *)&amp;addr, sizeof(struct sockaddr));
    // Ëøô‰∏ÄÊ≠•Â¶ÇÊûúÊ≤°ÊúâË∂ÖÁ∫ßÁî®Êà∑ÁöÑÊùÉÈôêÔºåÂ∞±‰ºöÊä•Èîô„ÄÇlinuxÂØπ‰∫éÈùûrootÊùÉÈôêÁî®Êà∑‰∏çËÉΩ‰ΩøÁî®1024‰ª•‰∏ãÁöÑÁ´ØÂè£
    exit_if(r, &#34;bind to 0.0.0.0:%d failed %d %s&#34;, port, errno, strerror(errno));
    /* 
    #include&lt;sys/socket.h&gt;
int listen(int sockfd, int backlog)
ËøîÂõûÔºö0‚îÄ‚îÄÊàêÂäüÔºå -1‚îÄ‚îÄÂ§±Ë¥•
ÂèÇÊï∞sockfd
Ë¢´listenÂáΩÊï∞‰ΩúÁî®ÁöÑÂ•óÊé•Â≠óÔºåsockfd‰πãÂâçÁî±socketÂáΩÊï∞ËøîÂõû„ÄÇÂú®Ë¢´socketÂáΩÊï∞ËøîÂõûÁöÑÂ•óÊé•Â≠ófd‰πãÊó∂ÔºåÂÆÉÊòØ‰∏Ä‰∏™‰∏ªÂä®ËøûÊé•ÁöÑÂ•óÊé•Â≠óÔºå
‰πüÂ∞±ÊòØÊ≠§Êó∂Á≥ªÁªüÂÅáËÆæÁî®Êà∑‰ºöÂØπËøô‰∏™Â•óÊé•Â≠óË∞ÉÁî®connectÂáΩÊï∞ÔºåÊúüÂæÖÂÆÉ‰∏ªÂä®‰∏éÂÖ∂ÂÆÉËøõÁ®ãËøûÊé•ÔºåÁÑ∂ÂêéÂú®ÊúçÂä°Âô®ÁºñÁ®ã‰∏≠ÔºåÁî®Êà∑Â∏åÊúõËøô‰∏™Â•óÊé•Â≠óÂèØ‰ª•Êé•ÂèóÂ§ñÊù•ÁöÑËøûÊé•ËØ∑Ê±ÇÔºå
‰πüÂ∞±ÊòØË¢´Âä®Á≠âÂæÖÁî®Êà∑Êù•ËøûÊé•„ÄÇÁî±‰∫éÁ≥ªÁªüÈªòËÆ§Êó∂ËÆ§‰∏∫‰∏Ä‰∏™Â•óÊé•Â≠óÊòØ‰∏ªÂä®ËøûÊé•ÁöÑÔºåÊâÄ‰ª•ÈúÄË¶ÅÈÄöËøáÊüêÁßçÊñπÂºèÊù•ÂëäËØâÁ≥ªÁªüÔºåÁî®Êà∑ËøõÁ®ãÈÄöËøáÁ≥ªÁªüË∞ÉÁî®listenÊù•ÂÆåÊàêËøô‰ª∂‰∫ã„ÄÇ
ÂèÇÊï∞backlog
Ëøô‰∏™ÂèÇÊï∞Ê∂âÂèäÂà∞‰∏Ä‰∫õÁΩëÁªúÁöÑÁªÜËäÇ„ÄÇÂú®ËøõÁ®ãÊ≠£ÁêÜ‰∏Ä‰∏™‰∏Ä‰∏™ËøûÊé•ËØ∑Ê±ÇÁöÑÊó∂ÂÄôÔºåÂèØËÉΩËøòÂ≠òÂú®ÂÖ∂ÂÆÉÁöÑËøûÊé•ËØ∑Ê±Ç„ÄÇ
Âõ†‰∏∫TCPËøûÊé•ÊòØ‰∏Ä‰∏™ËøáÁ®ãÔºåÊâÄ‰ª•ÂèØËÉΩÂ≠òÂú®‰∏ÄÁßçÂçäËøûÊé•ÁöÑÁä∂ÊÄÅÔºåÊúâÊó∂Áî±‰∫éÂêåÊó∂Â∞ùËØïËøûÊé•ÁöÑÁî®Êà∑ËøáÂ§öÔºå‰ΩøÂæóÊúçÂä°Âô®ËøõÁ®ãÊó†Ê≥ïÂø´ÈÄüÂú∞ÂÆåÊàêËøûÊé•ËØ∑Ê±Ç„ÄÇ
Â¶ÇÊûúËøô‰∏™ÊÉÖÂÜµÂá∫Áé∞‰∫ÜÔºåÊúçÂä°Âô®ËøõÁ®ãÂ∏åÊúõÂÜÖÊ†∏Â¶Ç‰ΩïÂ§ÑÁêÜÂë¢Ôºü
ÂÜÖÊ†∏‰ºöÂú®Ëá™Â∑±ÁöÑËøõÁ®ãÁ©∫Èó¥ÈáåÁª¥Êä§‰∏Ä‰∏™ÈòüÂàó‰ª•Ë∑üË∏™Ëøô‰∫õÂÆåÊàêÁöÑËøûÊé•‰ΩÜÊúçÂä°Âô®ËøõÁ®ãËøòÊ≤°ÊúâÊé•ÊâãÂ§ÑÁêÜÊàñÊ≠£Âú®ËøõË°åÁöÑËøûÊé•ÔºåËøôÊ†∑ÁöÑ‰∏Ä‰∏™ÈòüÂàóÂÜÖÊ†∏‰∏çÂèØËÉΩËÆ©ÂÖ∂‰ªªÊÑèÂ§ßÔºå
ÊâÄ‰ª•ÂøÖÈ°ªÊúâ‰∏Ä‰∏™Â§ßÂ∞èÁöÑ‰∏äÈôê„ÄÇËøô‰∏™backlogÂëäËØâÂÜÖÊ†∏‰ΩøÁî®Ëøô‰∏™Êï∞ÂÄº‰Ωú‰∏∫‰∏äÈôê„ÄÇ
ÊØ´Êó†ÁñëÈóÆÔºåÊúçÂä°Âô®ËøõÁ®ã‰∏çËÉΩÈöè‰æøÊåáÂÆö‰∏Ä‰∏™Êï∞ÂÄºÔºåÂÜÖÊ†∏Êúâ‰∏Ä‰∏™ËÆ∏ÂèØÁöÑËåÉÂõ¥„ÄÇËøô‰∏™ËåÉÂõ¥ÊòØÂÆûÁé∞Áõ∏ÂÖ≥ÁöÑ„ÄÇÂæàÈöæÊúâÊüêÁßçÁªü‰∏ÄÔºå‰∏ÄËà¨Ëøô‰∏™ÂÄº‰ºöÂ∞è30‰ª•ÂÜÖ„ÄÇ
ÂÜÖÊ†∏Áî®‰∫éË∑üË∏™Ëøô‰∫õÂÆåÊàêËøûÊé•‰ΩÜÊòØÁî®Êà∑‰ª£Á†ÅËøòÊ≤°ÊúâÈÄöËøáacceptË∞ÉÁî®ÁöÑÈòüÂàóÈïøÂ∫¶ËøôÈáåËÆæÁΩÆ‰∏∫‰∫Ü20„ÄÇÂú®ÈòüÂàóÈïøÂ∫¶Â∞è‰∫é20Êó∂ÔºåÂÜÖÊ†∏‰ºöÁ´ãÂç≥ÂÆåÊàêËøûÊé•ÁöÑÂª∫Á´ã„ÄÇ
‰ΩÜÊòØÂ¶ÇÊûúÈòüÂàóÈïøÂ∫¶Â§ß‰∫é20ÔºåÂú®Áî®Êà∑‰ª£Á†ÅË∞ÉÁî®accept‰πãÂâçËØ•ËøûÊé•ÈÉΩ‰∏ç‰ºöÂª∫Á´ãÔºåÂØπÊñπÂàôÂ§Ñ‰∫éÈòªÂ°ûÁä∂ÊÄÅ„ÄÇ
     */
    r = listen(listenfd, 20);
    exit_if(r, &#34;listen failed %d %s&#34;, errno, strerror(errno));
    printf(&#34;fd %d listening at %d\n&#34;, listenfd, port);
    // Êé•‰∏ãÊù•ËÆæÁΩÆÊñá‰ª∂ÊèèËø∞Á¨¶‰∏∫ÈòªÂ°û„ÄÇ
    // ‰∏∫‰ªÄ‰πàË¶ÅËÆæÁΩÆ‰∏∫ÈùûÈòªÂ°ûÔºühttps://www.zhihu.com/question/23614342
    setNonBlock(listenfd);
    // Â∞ÜÂÖ∂ËÆæÁΩÆ‰∏∫ÂèØËØªÂèñÊó∂Ëß¶ÂèëÔºåÊ∑ªÂä†Âà∞epollÊñá‰ª∂ÊèèËø∞Á¨¶Ê±†‰∏≠
    updateEvents(epollfd, listenfd, EPOLLIN, EPOLL_CTL_ADD);
    for (;;) { //ÂÆûÈôÖÂ∫îÁî®Â∫îÂΩìÊ≥®ÂÜå‰ø°Âè∑Â§ÑÁêÜÂáΩÊï∞ÔºåÈÄÄÂá∫Êó∂Ê∏ÖÁêÜËµÑÊ∫ê
        loop_once(epollfd, listenfd, 10000);
    }
    return 0;
}
</code></pre><h2 id="ËøêË°åÊïàÊûú">ËøêË°åÊïàÊûú
</h2><p><img src="https://upload-images.jianshu.io/upload_images/4388248-57aa370a0545fdb4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"
	
	
	
	loading="lazy"
	
		alt="image.png"
	
	
></p>
<pre tabindex="0"><code>sudo ./epoll
fd 4 listening at 80
add fd 4 events read 1 write 0
epoll_wait return 1
this is accept
accept a connection from 127.0.0.1
add fd 5 events read 1 write 0
epoll_wait return 1
this can read
read 412 bytes
now info is
---GET / HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36
Upgrade-Insecure-Requests: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9,und;q=0.8,zh-TW;q=0.7,en;q=0.6,pl;q=0.5


---
write 4081834 bytes left: 14966851
update it to EPOLLIN|EPOLLOUT
mod fd 5 events read 1 write 4
nothing to read from 5, return.
epoll_wait return 1
handling epollout
write 2226422 bytes left: 12740429
epoll_wait return 1
handling epollout
write 2095456 bytes left: 10644973
epoll_wait return 1
handling epollout
write 1964490 bytes left: 8680483
epoll_wait return 1
handling epollout
write 1506109 bytes left: 7174374
epoll_wait return 1
handling epollout
write 1833524 bytes left: 5340850
epoll_wait return 1
handling epollout
write 1637075 bytes left: 3703775
write 130966 bytes left: 3572809
epoll_wait return 1
handling epollout
write 1571592 bytes left: 2001217
epoll_wait return 1
handling epollout
write 1440626 bytes left: 560591
epoll_wait return 1
handling epollout
write 560591 bytes left: 0
mod fd 5 events read 1 write 0
epoll_wait return 1
this can read
read 375 bytes
now info is
---GET /favicon.ico HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36
Accept: image/webp,image/apng,image/*,*/*;q=0.8
Referer: http://127.0.0.1/
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9,und;q=0.8,zh-TW;q=0.7,en;q=0.6,pl;q=0.5


---
write 10477280 bytes left: 8571405
update it to EPOLLIN|EPOLLOUT
mod fd 5 events read 1 write 4
nothing to read from 5, return.
epoll_wait return 1
handling epollout
write 1440626 bytes left: 7130779
epoll_wait return 1
handling epollout
write 1768041 bytes left: 5362738
epoll_wait return 1
handling epollout
write 1571592 bytes left: 3791146
epoll_wait return 1
handling epollout
write 1637075 bytes left: 2154071
epoll_wait return 1
handling epollout
write 1702558 bytes left: 451513
epoll_wait return 1
handling epollout
write 451513 bytes left: 0
mod fd 5 events read 1 write 0
epoll_wait return 0
epoll_wait return 0
epoll_wait return 0
</code></pre><p>ËøôÈáåÊàëÂèëÈÄÅÁöÑËµÑÊ∫êÊîπÂ§ß‰∫ÜÔºåÊîπÊàêÂ¶Ç‰∏ãÁöÑÊï∞ÂÄºÔºö</p>
<pre tabindex="0"><code>    httpRes = &#34;HTTP/1.1 200 OK\r\nConnection: Keep-Alive\r\nContent-Type: text/html; charset=UTF-8\r\nContent-Length: 19048576\r\n\r\n123456&#34;;
    // Â∞ÜÂâ©‰∏ãÁöÑÂÜÖÂÆπÂ°´ÂÖÖÊàê0„ÄÇÊúÄÂêécontentÁöÑÈïøÂ∫¶ÊòØÂ§ßÁ∫¶1024*1024
    for(int i=0;i&lt;19048570;i++) {
        httpRes+=&#39;\0&#39;;
    }
</code></pre><p>ÂèØ‰ª•ÁúãÂà∞ÂàÜ‰∫ÜÂ§öÊ¨°‰º†Ëæì„ÄÇÊúÄÁªàÁªàÁ´ØÈ°µÈù¢‰∏äÊòæÁ§∫123456ÔºåÂêéÈù¢ÂÖ®ÈÉΩÊòØ\0Ôºå‰∏ç‰ºöÊòæÁ§∫„ÄÇ
ÂèØ‰ª•ÁúãÂà∞ÊµèËßàÂô®ËØ∑Ê±Ç‰∫Ü‰∏§Ê¨°Ôºå‰∏ÄÊ¨°ËØ∑Ê±ÇÊ†πÁõÆÂΩïÔºå‰∏ÄÊ¨°ËØ∑Ê±ÇÈ°µÈù¢ÁöÑÂõæÊ†áfavicon.ico</p>

</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "nansenli" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Nansen Li üåà ÔºàÊùéÊ•†Ê£ÆÔºâ
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.31.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
